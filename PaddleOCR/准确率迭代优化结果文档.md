# 准确率迭代优化结果文档

## 1. 测试环境
- CPU : Intel® Core™ i7-7500U CPU @ 2.70GHz × 4 
- Memory : 16GB

## 2. 分类标准
- 根据长宽比确定文档是上下型还是左右型
- 对分类结果进行投票确认文字阅读方向是自左向右还是自右向左

## 3. Baseline

- 无预处理
- 无检测优化
- 基于分数的文字方向投票

### 总体情况

| 总准确率 | 文档朝向准确率 | 上下朝向准确率 | 左右朝向准确率 | 文字方向准确率 | 正向文字准确率 | 反向文字准确率 |
|:-------:|:-------------:|:--------------:|:-------------:|:-------------:|:--------------:|:-------------:|
| 96.44%  | 99.69%        | 99.78%         | 99.61%        | 96.58%        | 97.24%         | 95.95%        |

### 方向

| 方向准确率      | Up acc | Down acc | Left acc | Right acc | Avg acc |
|:--------------:|:------:|:--------:|:--------:|:---------:|:-------:|
| 平均           | 99.66% |  99.78%  |  92.17%  |   94.31%  |  96.44% |

### 种类

| 种类            | Up acc | Down acc | Left acc | Right acc | Avg acc |
|:---------------:|:------:|:--------:|:--------:|:---------:|:-------:|
| 证件            | 100.0% |  100.0% |    88.53% |    93.97% |  95.38% |
| 文档            | 99.69% |  99.64% |    89.47% |    89.90% |  94.67% |
| 票据            | 99.33% |  99.68% |    95.79% |    98.93% |  98.42% |
| 其他            | 100.0% |  100.0% |    97.03% |    95.15% |  98.00% |

## 4. 错因探究

通过对错误文档进行分析，发现了如下所述的情况．  
通常来说，文字检测模块预测的文字框坐标顺序为文字框的左上角，右上角，右下角，左下角．而对于一些有小角度倾斜的文档图片，文字检测结果却变为了左下角，左上角，右上角，右下角．这样的文字检测结果在对不规则四边形做仿射变换之时会颠倒文字框的宽高，出现宽高比跨`1`变换的情况．导致本应被分类为正向/逆向文字的文字框被分类为了逆向/正向文字．

具体的统计情况如下所示:

对Baseline预测结果的分析如下所示:

```
错误图片总数: 122 错误仿射变换总数: 101 错误仿射变换占比: 82.79% 平均错误仿射变换比例: 52.48%
正确图片总数: 3478 错误仿射变换总数: 910 错误仿射变换占比: 26.16% 平均错误仿射变换比例: 19.26%
```

通过统计数据可以看到，预测正确的图片中错误仿射变换的数量是预测错误的图片中错误仿射变换的数量的三倍有余．此外，含有错误仿射变换文字框的预测正确的图片当中，错误仿射变换文字框只占20%,对投票结果影响不大．而对含有错误仿射变换文字框的预测错误的图片，其错误仿射变换文字框占比超过50%,这一定会左右到投票结果．

此外，再观察经过图片微调转正后的分析结果:

```
错误图片总数: 32 错误仿射变换总数: 3 错误仿射变换占比: 9.38% 平均错误仿射变换比例: 17.88%
正确图片总数: 3568 错误仿射变换总数: 47 错误仿射变换占比: 1.32% 平均错误仿射变换比例: 14.67%
```

通过统计数据可以看到，预测正确的图片中错误仿射变换的数量占比已不足2%,预测错误的图片中错误仿射变换的数量也压缩到了10%以内．此外，无论是含有错误仿射变换文字框的预测正确还是预测错误的图片，错误仿射变换文字框占比都有了很大程度的降低．这些都使得总体准确率大幅提升．

最后，再观察对准确率高达99.53%的实验的分析结果:

```
错误图片总数: 17 错误仿射变换总数: 1 错误仿射变换占比: 5.88% 平均错误仿射变换比例: 100.0%
正确图片总数: 3583 错误仿射变换总数: 22 错误仿射变换占比: 0.61% 平均错误仿射变换比例: 29.26%
```

通过统计数据可以看到，预测正确的图片中错误仿射变换的数量占比已不足1%．进一步地，拥有20个类的3600张图片的测试集中只有一张图片出现了错误仿射变换的情况，这也反应了迭代优化工作的顺利完成．

## 5. 优化方案

### 5.1 预处理

- 二值化 : 对图片做高斯自适应二值化
- 微调转正 : 运用最大矩形框检测法对图片进行角度微调

### 5.2 检测优化

- 逆宽高比过滤 : 对检测框不符合投票结果方向宽高比的，进行删除过滤
- 阈值宽高比过滤 : 对经过仿射变换及旋转处理后检测框宽高比小于`2`的，进行删除过滤
- 修正仿射变换 : 对横纵边之比与仿射变换宽高比在`1`两侧的矩形框，进行坐标顺序调整

### 5.3 分类优化

- 基于个数的文字方向投票 : 使用个数而非置信度进行投票

### 5.4 复合优化

- 微调转正 + 逆宽高比过滤
- 微调转正 + 逆宽高比过滤 + 删除错误仿射变换
  - 删除错误仿射变换 : 对横纵边之比与仿射变换宽高比在`1`两侧的矩形框，进行删除
- 微调转正 + 逆宽高比过滤 + 旋转阈值为1的仿射变换
  - 旋转阈值 : 对经过仿射变换处理后的矩形框，如若高宽比 > 1，进行旋转 (Baseline中该阈值为1.5)
- 微调转正 + 逆宽高比过滤 + 阈值宽高比过滤
- 微调转正 + 二值化 + 逆宽高比过滤
- 微调转正 + 二值化 + 逆宽高比过滤 + 修正仿射变换

## 6. 基于Baseline的优化

| 总体情况               | 总准确率 | 文档朝向准确率 | 上下朝向准确率 | 左右朝向准确率 | 文字方向准确率 | 正向文字准确率 | 反向文字准确率 |
|:---------------------:|:--------:|:-------------:|:-------------:|:-------------:|:-------------:|:--------------:|:-------------:|
| Baseline              |  96.44%  | 99.69%        | 99.78%        | 99.61%        | 96.58%        | 97.24%         | 95.95%        |
| 基于个数的文字方向投票 |  95.94%  | 99.69%        | 99.78%        | 99.61%        | 96.08%        | 97.24%         | 94.96%        |
| 修正仿射变换           |  96.61%  | 99.69%        | 99.78%        | 99.61%        | 96.75%        | 97.13%         | 96.39%        |
| 逆宽高比过滤           |  96.86%  | 99.69%        | 99.78%        | 99.61%        | 97.00%        | 97.58%         | 96.44%        |


| 方向准确率             | Avg acc | Up acc | Down acc | Left acc | Right acc |
|:---------------------:|:-------:|:------:|:--------:|:--------:|:---------:|
| Baseline              |  96.44% | 99.66% |  99.78%  |  92.17%  |   94.31%  |
| 基于个数的文字方向投票 |  95.94% | 99.66% |  99.33%  |  90.67%  |   94.31%  |
| 修正仿射变换           |  96.61% | 99.66% |  99.78%  |  93.03%  |   94.08%  |
| 逆宽高比过滤           |  96.86% | 99.66% |  99.66%  |  93.24%  |   94.99%  |

## 7. 预处理

| 总体情况               | 总准确率 | 文档朝向准确率 | 上下朝向准确率 | 左右朝向准确率 | 文字方向准确率 | 正向文字准确率 | 反向文字准确率 |
|:---------------------:|:--------:|:-------------:|:-------------:|:-------------:|:-------------:|:--------------:|:-------------:|
| Baseline              |  96.44%  | 99.69%        | 99.78%        | 99.61%        | 96.58%        | 97.24%         | 95.95%        |
| 二值化                |  96.47%  | 99.67%        | 99.66%        | 99.67%        | 96.69%        | 97.18%         | 96.22%        |
| 微调转正              |  99.11%  | 99.72%        | 99.78%        | 99.67%        | 99.31%        | 99.72%         | 98.90%        |


| 方向准确率             | Avg acc | Up acc | Down acc | Left acc | Right acc |
|:---------------------:|:-------:|:------:|:--------:|:--------:|:---------:|
| Baseline              |  96.44% | 99.66% |  99.78%  |  92.17%  |   94.31%  |
| 二值化                |  96.47% | 99.66% |  98.99%  |  93.13%  |   94.20%  |
| 微调转正              |  99.11% | 99.55% |  99.78%  |  97.75%  |   99.43%  |

## 8. 复合优化

### 微调转正 + 二值化

| 总体情况                                       | 总准确率 | 文档朝向准确率 | 上下朝向准确率 | 左右朝向准确率 | 文字方向准确率 | 正向文字准确率 | 反向文字准确率 |
|:---------------------------------------------:|:--------:|:-------------:|:-------------:|:-------------:|:-------------:|:--------------:|:-------------:|
| Baseline                                      |  96.44%  | 99.69%        | 99.78%        | 99.61%        | 96.58%        | 97.24%         | 95.95%        |
| 微调转正 + 二值化 + 逆宽高比过滤               |  98.97%  | 99.56%        | 99.61%        | 99.50%        | 99.14%        | 99.61%         | 98.69%        |
| 微调转正 + 二值化 + 逆宽高比过滤 + 修正仿射变换 |  98.81%  | 99.56%        | 99.61%        | 99.50%        | 98.97%        | 98.49%         | 98.47%        |


| 方向准确率                                     | Avg acc | Up acc | Down acc | Left acc | Right acc |
|:---------------------------------------------:|:-------:|:------:|:--------:|:--------:|:---------:|
| Baseline                                      |  96.44% | 99.66% |  99.78%  |  92.17%  |   94.31%  |
| 微调转正 + 二值化 + 逆宽高比过滤               |  98.97% | 99.55% |  98.77%  |  98.39%  |   99.20%  |
| 微调转正 + 二值化 + 逆宽高比过滤 + 修正仿射变换 |  98.81% | 99.55% |  98.77%  |  97.96%  |   98.98%  |

### 微调转正

| 总体情况                                              | 总准确率 | 文档朝向准确率 | 上下朝向准确率 | 左右朝向准确率 | 文字方向准确率 | 正向文字准确率 | 反向文字准确率 |
|:----------------------------------------------------:|:--------:|:-------------:|:-------------:|:-------------:|:-------------:|:--------------:|:-------------:|
| 微调转正 + 逆宽高比过滤                               |  99.47%  | 99.72%        | 99.78%        | 99.67%        | 99.61%        | 99.89%         | 99.34%        |
| 微调转正 + 逆宽高比过滤 + 删除错误仿射变换             |  98.89%  | 99.56%        | 99.61%        | 99.50%        | 99.06%        | 99.61%         | 98.52%        |
| 微调转正 + 逆宽高比过滤 + 旋转阈值为1的仿射变换        |  99.39%  | 99.72%        | 99.78%        | 99.67%        | 99.58%        | 99.83%         | 99.34%        |
| **微调转正 + 逆宽高比过滤 + 阈值宽高比过滤**           |  99.53%  | 99.72%        | 99.78%        | 99.67%        | 99.72%        | 100.0%         | 99.45%        |
| 微调转正 + 逆宽高比过滤 + 阈值宽高比过滤 + 修正仿射变换 |  99.36%  | 99.72%        | 99.78%        | 99.67%        | 99.56%        | 99.83%         | 99.29%        |

| 方向准确率                                             | Avg acc | Up acc | Down acc | Left acc | Right acc |
|:-----------------------------------------------------:|:-------:|:------:|:--------:|:--------:|:---------:|
| 微调转正 + 逆宽高比过滤                                |  99.47% | 99.55% |  99.78%  |  98.71%  |   99.89%  |
| 微调转正 + 逆宽高比过滤 + 删除错误仿射变换              |  98.89% | 99.55% |  98.77%  |  98.07%  |   99.20%  |
| 微调转正 + 逆宽高比过滤 + 旋转阈值为1的仿射变换         |  99.39% | 99.55% |  99.78%  |  98.61%  |   99.60%  |
| 微调转正 + 逆宽高比过滤 + 旋转阈值为1的仿射变换         |  99.39% | 99.55% |  99.78%  |  98.61%  |   99.60%  |
| **微调转正 + 逆宽高比过滤 + 阈值宽高比过滤**           |  99.53% | 99.66% |  99.78%  |  98.82%  |   99.89%  |
| 微调转正 + 逆宽高比过滤 + 阈值宽高比过滤 + 修正仿射变换 |  99.36% | 99.66% |  99.78%  |  98.50%  |   99.54%  |
