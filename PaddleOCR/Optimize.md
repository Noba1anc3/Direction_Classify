# 基于PaddleOCR的文档方向四分类迭代优化方案

## Baseline

### Pipeline

#### 文字检测

将文档图像输送到DBModel中进行文字检测任务．对检测结果产生的四边形框计算宽高比，使用宽高比加权投票法判断文档朝向是上下型还是左右型．

#### 四边形矫正

将文字检测任务产生的四边形进行仿射变换矫正，使其成为一个矩形．并根据宽高比判断是否需要旋转．

#### 文字方向识别

对文档中的每个文字行进行方向检测，模型预测出方向和置信度．使用置信度加权投票法判断文字朝向是正向还是反向．

#### 结果综合

综合宽高比加权投票结果和置信度加权投票结果，确定文档朝向属于四方向中的哪一种．

### PaddleOCR表现

#### 测试集

测试集共有18个类，每类有200张文档图片，共计3600张文档图片．

#### 测试环境

- CPU : Intel® Core™ i7-7500U CPU @ 2.70GHz × 4 

#### 总体表现

| 时间消耗 | 最大值  | 最小值 | 平均值 |
| :------: | :-----: | :----: | :----: |
| 检测时间 | 2984.86 | 31.47  | 418.89 |
| 分类时间 | 7225.24 |  0.0   | 489.44 |
|  总时间  | 7660.99 | 42.72  | 908.33 |

| 方向准确率 | Up acc | Down acc | Left acc | Right acc | Avg acc |
| :--------: | :----: | :------: | :------: | :-------: | :-----: |
|    平均    | 99.66% |  99.78%  |  92.17%  |  94.31%   | 96.44%  |

#### 各类表现

| 种类 | Up acc | Down acc | Left acc | Right acc | Avg acc |
| :--: | :----: | :------: | :------: | :-------: | :-----: |
| 证件 | 100.0% |  100.0%  |  88.53%  |  93.97%   | 95.38%  |
| 文档 | 99.69% |  99.64%  |  89.47%  |  89.90%   | 94.67%  |
| 票据 | 99.33% |  99.68%  |  95.79%  |  98.93%   | 98.42%  |
| 其他 | 100.0% |  100.0%  |  97.03%  |  95.15%   | 98.00%  |

#### 表现分析

总体来说，PaddleOCR在该测试集上取得了不错的表现．若想进一步提升效果，需要对模型表现进行分析．

PaddleOCR通过两个步骤得到文档所属分类，首先判断文档朝向而后判断文字朝向．同样地，对结果的分析也分成了这两部分．

##### 文档朝向准确率

通过检查预测结果和标注信息，基于检测框宽高比加权投票的文档朝向分类准确率结果如下：

|   PaddleOCR    | 总体准确率 | 上下准确率 | 左右准确率 |
| :------------: | :--------: | :-------: | :--------: |
| 文档朝向准确率 |   99.69%   |   99.78%   |   99.61%   |

从结果可以看出文档朝向准确率有很高的分数，侧面说明文字检测是十分成功的，并且验证实了使用四边形纵边边长除以横边边长来计算宽高比的准确性．

这里通过调整宽高比计算方案的优化空间基本不大，优化重点应放在文字方向分类任务当中．

##### 文字朝向准确率

通过检查预测结果和标注信息，基于置信度加权投票的文档文字方向分类准确率结果如下：

|   PaddleOCR    | 总体准确率 | 正向准确率 | 逆向准确率 |
| :------------: | :--------: | :--------: | :--------: |
| 文字朝向准确率 |   96.58%   |   97.24%   |   95.95%   |

从结果可以看出文字朝向分类准确率已经达到了较高的分数，不过仍有一定的提升空间．

我们可以看到两种方法的正向准确率都高于逆向准确率，侧面说明正向文字文档相比于逆向文字文档更好判断．

## 优化方案

### 错因探明

从以上统计的准确率可以看出，文档方向四分类错误主要由文字朝向分类错误导致．

经过初步实验，我们发现文字朝向判断错误的其中一个原因是对有一定偏转角度的纵向文档文字检测结果的坐标顺序与常规顺序不一致导致仿射变换时宽高判断错误，造成文字朝向判断出错．对这一问题的具体确认，分析和修正还需要进一步的实验和结果分析．

进一步地，应当对正向和逆向准确率进行拆解，分别统计上向及右向文档的文字正向准确率和下向及左向文档的文字逆向准确率．此外，应当找到所有的错误文档图像，汇总其主要特点，通过对结果进行统计分析的方式判明错误分类的主要原因．

### 时间优化

在Baseline当中，总时间消耗如下所示：

- 0 ~ 300ms : 10.33%
- 300 ~ 500ms : 23.89%
- 500 ~ 1000ms : 43.17%
- 1000 ~ 2000ms : 14.25%
- 2000ms ~ : 8.36%

经过分析，有34.13%的文档能在500ms之内完成分类，有77.3%的文档能在1000ms之内完成分类．不过仍有22.61%的文档需要在一秒之上完成分类．

优化方案：降低检测任务阈值，减少分类任务文字框使用数量

任务优先级：由于该分数是在CPU环境下得到，在GPU上耗时将进一步降低，其优先级低于精度优化任务．

### 精度优化

精度优化从三个方面展开，一方面是采用一定的过滤策略使得更多正确朝向的文字行被输送到分类模型中，更多正确预测的文字行被保留下来进行投票．另一方面是采用更好的投票策略使得投票结果更加准确．此外，通过使用诸如二值化和微调转正等预处理策略尝试提升精度．

#### 过滤策略

#### 基于宽高比的文字框过滤

该过滤策略需要联动前一阶段基于文字检测结果计算出的宽高比．对于不符合投票结果宽高比的文字行，进行舍弃，只保留宽高比与投票结果一致的文字行．

#### 基于置信度阈值的文字框过滤

在Baseline当中，无论一个文字行被预测出来的置信度有多高，都会被计入加权投票当中．而该策略旨在设定一定的置信度阈值，低于该阈值的文字行进行舍弃，只保留拥有更高置信度阈值的文字行．

#### 投票策略

##### 基于个数的投票

统计分类模型预测出的文档内所有文字行的朝向，更多的一方被认定为文档方向．

##### 基于置信度的加权投票

统计分类模型预测出的文档内所有文字行朝向的置信度，置信度之和更大的一方被认定为文档方向．该方法也是Baseline所使用的方案．

##### 基于宽高比的加权投票

对分类模型预测出的文档内所有文字行，宽高比更大的被赋予更高的权重，统计两个方向的加权结果，更多的一方被认定为文档方向．

#### 预处理

##### 二值化

颜色信息对方向四分类任务来说属于无关特征，这可能会影响模型对方向的判断．在此尝试使用自适应二值化的策略进行图像预处理，查看有无效果提升．

##### 微调转正

有一定小角度的文档并没有朝向平行于水平/铅锤轴的文档分类准确度高．因此在这里尝试使用opencv的方法对文档图像进行小角度的微调转正，在此基础之上再进行方向四分类．

### 微调PaddleOCR模型

目前拥有上万条文字行可以用于对PaddleOCR分类模型的微调，如果经过投票策略和过滤策略的调整之后模型仍然无法达到预期目标，可以尝试利用文字行数据对该模型进行微调，提升其在文档当中的表现．

### 从零训练文字朝向二分类模型

除微调PaddleOCR所使⽤的分类模型之外，在基于⽂档图像的四分类实验结果指导下训练⼀个⽂字朝向⼆分类模型．

## 工作计划

- 10.10 : 探明文字朝向分类错误的主要原因，尝试提出和实现优化方案
- 10.12 : 使用二值化和微调转正的预处理策略对测试集进行测试
- 10.13 : 完成基于宽高比的文字框过滤和基于宽高比的加权投票实验
- 10.14 : 对以上内容进行汇总，完成迭代优化文档

