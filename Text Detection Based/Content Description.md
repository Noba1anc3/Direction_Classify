# 基于文字检测的文档方向四分类任务的内容说明与工作安排

## 文档方向四分类任务说明

### 文档方向四分类

文档方向四分类是OCR领域的一个重要前置步骤，只有正确地判断出当前文档的方向并将其矫正才能确保后面的文字检测识别等任务可以接收到正确的输入．在该任务中，文档的方向被归类为四种，具体示例见附录①，它们分别是: 

- 右向文档：文字阅读方向在水平线顺时针旋转330° - 30°之间
- 下向文档：文字阅读方向在水平线顺时针旋转60° - 120°之间
- 左向文档：文字阅读方向在水平线顺时针旋转150° - 210°之间
- 上向文档：文字阅读方向在水平线顺时针旋转240° - 300°之间

### 任务描述

该任务首先通过文字检测的方法提取出文档内所有文字行，而后利用这些文字行信息进行特征提取，预测文档的方向。

### 任务范围

需要解决的文档类型不限于传统的电子版文档，还包括扫描版，拍照版的文档．任务致力于训练出一个通用的文档方向四分类模型，不仅能应用在发票，表单，财报等常见金融文档类型，还要能应用在证件，车票，门票等生活文档当中，具有较强的通用性．

### 任务目标
当前阶段的任务目标是能够以98%以上的准确率正确分类文字朝向严格平行于水平线/铅垂线的文档，以95%以上的准确率正确分类文字朝向相较于水平线/铅垂线的偏差在10°以内的文档，以90%以上的准确率正确分类文字朝向相较于水平线/铅垂线的偏差在10°以上,20°以下的文档，并应当能够较好的分类文字朝向相较于水平线/铅垂线的偏差在20°以上,30°以下的文档．后续会根据具体的实验情况设定阶段性的目标．

## 文字检测

### 轻量级模型的使用

鉴于文字检测的结果应用于对检测精度要求不高的方向分类任务而非要求较高的文字识别任务，并且该两步走方案不可避免地需要更多的时间来进行模型推理和中间处理。因此对文字检测任务来说，使用拥有较多参数，较深网络的检测模型是不必要的，只要该模型能够对四个方向的文档都能够比较准确地框出大部分文字行所在的位置即可。

基于以上原因，轻量级的文字检测模型成为了首选。鉴于我们想要解决的问题是比较通用的中文文档方向的四分类，考虑使用ChineseOCR_Lite作为当前阶段的文字检测模型。

### ChineseOCR_Lite

[ChineseOCR_Lite](https://github.com/ouyanghuiyu/chineseocr_lite)是一个超轻量级中文OCR工具，支持文字方向检测，竖排文字识别, ncnn推理 ( dbnet(1.8M) + crnn(2.5M) + anglenet(378KB))，总模型仅4.7M．

在原测试集中，在四个类别中分别挑选了一张图像来测试ChineseOCR_Lite的表现，其中既有拍照版的图像，也有电子版的图像．效果详见附录②．

通过观察模型的预测结果可以看出，四个方向的文档当中无论是文字所在的位置亦或是文字行所在的方向绝大多数都在很短的推理时间内被正确的识别出来了，这验证了该轻量级模型在不同方向文档当中的技术可行性．

通过阅读坐标，可以发现返回的坐标并不是标准的矩形，而是一个由四个点构成的多边形，这可以很大程度上避免因为偏转角度过大导致许多背景信息和无关信息被纳入到标注框之中．

### 当下的工作

经过数十张文档的测试，可以发现绝大多数四方向文档当中的绝大多数文字区域的方向都能很好的预测出来，因此在当下阶段可以直接使用该模型作为文字检测的工具．该开源工具直接提供了web服务并预留了相关的前端接口方便测试者使用，但并不方便开发人员进行核心业务拆分与接口保留．因此当下阶段的工作内容是：
- 阅读代码，找到上传图像和返回结果的具体变量和方法
- 拆分出文字方向检测这一核心业务，并封装图像获取和结果返回的变量和方法
- 将以上部分作为整体工程的一部分加入到工程项目当中，进行中间处理，以对接后面的文字方向识别任务

### 未来的工作

可以看到经由ChineseOCR_Lite模型计算出的文字方向虽然绝大多数都是正确的，但仍然有个别漏检和误检的情况．如果想要更进一步的提升该文字方向四分类解决方案的效果，这里仍然有着一定的提升空间．届时，基于业务相关的文档来微调该模型，可以进一步提升模型表现，降低漏检和误检的情况．

## 方向四分类

### 文字行级解决方案（优先）

文字行级的解决方案将特征提取这一任务锁定在每个文字行上．该方法无法学习到整个文档的特征，但能够让模型把握每一个文字行的特征．

该方案的策略是将所有样本当中的文字行调整到一个合适的统一尺寸，即一系列(W, H, 3)的矩阵，W和H表示文字行的宽高，3表示文字行的通道数．在该方案中，用于神经网络训练的样本单元是文字行．使用卷积神经网络在文字行上进行特征提取，并通过全连接和激活函数得到每个文字行的方向，最终使用投票的方式得到文档的方向．

该方案的特点如下：
- 作为纯粹的文字行级解决方案，模型在训练过程中不会把握到文档总体的特征，而是每一个文字行的信息
- 由于摆脱了文档本身的约束，其训练过程类似随机梯度下降．可能拟合的速度会有所下降，但理论上可以取得更好的结果
- 使用投票的方式裁定文档类别，具有一定的鲁棒性

### 文档级解决方案（暂缓）

文档级解决方案不会单独考虑每一个文字行，而是将一篇文档中的所有文字行作为一个整体进行卷积运算来抽取特征．这种方式的优点是可以让模型在一定程度上把握文档的全局特征，缺点是相对忽视每一个文字行的信息．

该方案的策略是将每个样本中的所有文字行调整到一个合适的统一尺寸后堆叠起来，形成一个(N, W, H, 3)的矩阵，N表示样本堆叠数量，W和H表示文字行的宽高，3表示文字行的通道数．在该方案中，用于神经网络训练的样本单元是文档，使用卷积神经网络在文档上进行特征提取，并通过全连接和激活函数得到文档的方向．

该方案的特点如下：
- 通过堆叠操作，所有文字行作为一个整体被考虑而不是一个个单独的个体，能让模型学习到更总体的特征
- 相对应的，这可能让模型在一定程度上忽略每个文字行的特征
- 特别地，将三通道数据转换为单通道数据，去除与类别无关的颜色信息，不仅可以降低计算量，还可以避免模型对颜色信息产生"记忆"

### 未来的工作

文档方向检测除了上述两种解决方案外，还可以采取诸如将文字特征和图像特征进行特征融合等其他方案，尚且有一定的探索空间．

## 基于文字行级解决方案的可行简化思路

### 思路阐述

基于一定的规则可以判断经由ChineseOCR_Lite产生的文字行是左右朝向的还是上下朝向的，而上下朝向的文字行又可以经过90°的旋转变为左右朝向的文字行．因此，原有四分类任务可以转变为二分类任务，即第二步骤的模型只需要判断文字的阅读方向是从左向右还是从右向左，这可以在较大程度上降低分类任务的难度．

### 模型数据集

对任务数据集当中的每张文档以50%的概率旋转180°，生成对应的图像和标签．对任务数据集中的文档数据，使用ChineseOCR_Lite将其转换为一系列文字行．对任务数据集中的自然场景数据则可以直接使用，二者共同构成模型数据集．

### 模型结构拟定

ResNet50是一个很常用的图片特征提取模型，但对于文字行的二分类任务而言不免有些＂庞大＂．因而在此可以首先尝试对卷积，池化进行若干层的简单堆叠，通过实验查看模型效果，而后根据验证集上的表现再做出针对性的结构修改．如果表现的不是很理想，再尝试使用诸如ResNet50这样的复杂网络结构进行特征提取．

### 需要解决的问题

对以下讨论中涉及到的一些概念的定义与说明

多边形长边 : 顶点间欧氏距离或投影至坐标轴上的长度最长的边  
多边形横边 : 四条边中与水平轴夹角最小的边是为多边形横边  
多边形竖边 : 四条边中与垂直轴夹角最小的边是为多边形竖边  

宽高比计算方案 : 
- 对多边形的两条长边相较于水平线的角度取平均，计算余切值．
- 将多边形的横边和竖边投影到水平轴和垂直轴，计算两个投影边的长度比．
- 直接计算多边形横边和竖边的长度比．

#### ChineseOCR_Lite的标注框为多边形

该工具为了很好的解决倾斜文字行的标注问题，使用了四边形而非矩形对文字区域的四个顶点进行了精准标注．而在网络训练时需要使用的是一个固定大小的矩形作为输入，在此就需要对工具产生的文字框区域进行后处理以满足神经网络训练的要求．

可能的方案：
- 方案一 : 对多边形的四个顶点，取其横坐标和纵坐标的最小最大值，构成一个能包围住四边形的矩形区域，对多出来的部分进行0填充或空白填充．
- 方案二 : 对多边形进行旋转至长边平行于横轴，并使用方案一进行矩形扩展和填充．

#### ChineseOCR_Lite文字检测结果过滤

面对自然场景图像时，该工具会将许多无关内容预测为文字部分．虽然在文档数据上的误识别率会下降许多，但仍不排除其产生错误文字框的可能性．而这样的文字框会影响模型的训练过程．

可能的方案：
- 方案一 : 对工具产生的文字检测结果计算宽高比，如果超过了某一个阈值则确定其为一个文字行
  - 优点 : 在一定程度上能过滤误识别
  - 缺点 : 提升准确率的同时会降低召回率，一些短文本可能会受到阈值设定的影响；宽高比的计算方式也会影响对结果取舍的判断
- 方案二 : 对工具产生的文字检测结果分数设定阈值，只选取拥有较高分数的结果
  - 优点 : 时间成本比较低
  - 缺点 : 同样地，提升准确率的同时会降低召回率

#### 文档大方向的二分类问题

经过工具会产生一系列矩形框，通过文字检测结果过滤后，在这里默认剩下的所有检测框都是正确的文字框．此时，我们需要借由这些文字框信息来判断文档的文字朝向是水平朝向还是垂直朝向，以把文档方向判定问题的类别缩小一半．因此，如果通过文字框判断文档方向成为了一个问题．

可能的方案：
- 方案一 : 个数投票法
  - 对每个矩形框，如果其宽高比大于一，记水平向一票．反之，记垂直向一票．统计所有的文字行方向来投票最终文档的方向．
- 方案二 : 宽高比加权投票法
  - 对每个矩形框，如果其宽高比大于一，在水平向分数上加上当前文字行的宽高比．反之，在垂直向分数上加上当前文字行宽高比的倒数．统计所有的文字行，最终比较两个分数的大小．更大的一方被认为是文档的朝向．
- 方案三 : 平均角度法
  - 对所有矩形框，计算其长边相对水平线的倾斜角，并取平均值．如若平均角介于(-π/2, π/2)之间，认为文档是横向的．如若平均角介于(π/2, 3π/2)之间，认为文档是纵向的．

## 任务数据集

### 测试集

使用已制作好的[测试数据](http://47.98.230.217:3000/Doc_SemSeg/labelImg/wiki/%E6%96%87%E5%AD%97%E6%96%B9%E5%90%91%E5%9B%9B%E5%88%86%E7%B1%BB%E6%B5%8B%E8%AF%95%E9%9B%86%E5%88%B6%E4%BD%9C)作为文档方向四分类任务的测试集，用于测定训练好的模型的最终表现．

### 训练与验证集

#### 文档数据

- 银行流水 : 26
- 浦发大赛 : 44
- 车票 : 50
- 机票 : 50
- 教材 : 50
- 名片 : 50
- 募集 : 50
- 电子书 : 50
- 体检报告 : 50
- 年度报告 : 50
- 评级报告 : 50
- 增值税发票 : 50
- 出租车发票 : 50
- 收据 : 65
- 证件 : 65
- 门票 : 100 
- 试卷 : 100
- 振洋数据集 : 150
- 营业执照 : 200  
- 身份证 : 200

共计：20个类别，1500张图片

#### 自然场景数据

自然场景文字数据集为清华大学和腾讯联合提出的CTW中文街景数据集，共包含32285张图片．在此选取其测试集作为本任务自然场景数据的扩充部分，共5418张图片(附录③)．

目前已通过ChineseOCR_Lite处理并挑选出1000个高质量文字行（附录④）．由于该工具面对自然场景的文档图像会产生许多误检和重复结果(附录⑤)，筛选时间成本较高，另外由于该数据集作为文档数据集的扩充部分，现阶段其数量不需过多，在此计划增添1000个文字行，共计2000条文字行数据．

#### 数据旋转与划分

对文档数据集和自然场景数据集共计1500张图片+2000张文字行中的每个样本随机进行角度变换，角度变换的方案如下：
- 方案一 : 仅使用旋转，角度为 (0, 90, 180, 270) ± 15°
- 方案二 : 在90度整数倍调整的基础之上，进行小角度旋转

对生成的数据集，进行3:1的划分．其中训练数据占3/4，测试数据占1/4．

## 评价指标

### 模型性能

使用准确率作为模型性能的评价指标

具体需要统计的准确率为:
- 测试集各大类的各方向准确率及类准确率
- 测试集各小类的各方向准确率及类准确率
- 测试集在各方向的准确率及总准确率

### 时间消耗

该方案是一个多阶段方案，有两次模型的调用和一系列预处理，中间处理和后处理以串联起整个数据流．因此，时间消耗在这里是一个需要关注的问题．整个推理过程的时间消耗被定义为如下三部分：
- 文字检测时间 : 规定为图片从被输送到模型开始到产生预测结果的时间消耗
- 中间处理时间 : 规定为对检测到的文字进行内容过滤，矩形填充，尺寸调整，和旋转至横向所需要的时间总和
- 方向分类时间 : 规定为文档内文字行从被输送到模型进行推理开始到对模型产生的结果进行投票，得到文档方向为止所需要的时间

## 工作安排

### Day1

确定工作内容与工作安排

### Day2

确定拟定的工作内容与安排有无纰漏和错误，并确定一个具体的解决方案，制作与解决方案相对应的数据集

### Day3

完成ChineseOCR_Lite，即文字检测任务的相关工作，完成文档方向四分类文档的撰写和评审

### Day4

对确定的具体解决方案的网络结构，损失函数，超参数等配置进行设定并开始编码

### Day5

完成代码编写，debug，检查程序能够正确运行等事项，和数据一同上传到colab当中，确保可以开展训练

### Day6

开展训练，争取能得到第一版训练结果．编写训练结果解析程序，自动化完成各个类别和方向的分数统计．

### Day7

将训练过程的情况，训练结果，各个类别的分数情况加以汇总，撰写文档，制图，制表，完成实验文档．



